<!DOCTYPE html>
<html lang="zh-CN">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Three.js Editor - ThreeJSAssetsManager</title>

    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Arial', sans-serif;
            background: #000;
            overflow: hidden;
        }

        #canvas01 {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            outline: none;
        }
    </style>

    <!-- Import Maps é…ç½® -->
    <script type="importmap">
    {
        "imports": {
            "three": "https://gcore.jsdelivr.net/npm/three@0.179.1/build/three.module.js",
            "three/addons/": "https://gcore.jsdelivr.net/npm/three@0.179.1/examples/jsm/",
            "lil-gui": "https://gcore.jsdelivr.net/npm/lil-gui@0.18.1/dist/lil-gui.esm.min.js",
            "cannon-es": "https://cdn.jsdelivr.net/npm/cannon-es@0.20.0/dist/cannon-es.js"
        }
    }
    </script>

    <!-- é¢„åŠ è½½å¹¶è¦†ç›–é…ç½® -->
    <script type="module">
        // å…ˆå¯¼å…¥é»˜è®¤é…ç½®å’Œè‡ªå®šä¹‰é…ç½®
        import defaultConfig from '../ThreeJSAssetManager/ThreeJSAssetsManager/config.js';
        import editConfig from './config.js';

        // æ·±åº¦åˆå¹¶é…ç½®
        function deepMerge(target, source) {
            for (const key in source) {
                if (source[key] && typeof source[key] === 'object' && !Array.isArray(source[key])) {
                    target[key] = target[key] || {};
                    deepMerge(target[key], source[key]);
                } else {
                    target[key] = source[key];
                }
            }
            return target;
        }

        // ç”¨ Edit é…ç½®è¦†ç›–é»˜è®¤é…ç½®
        deepMerge(defaultConfig, editConfig);

        console.log('âœ… Edit config merged into default config');

        // å°†åˆå¹¶åçš„é…ç½®å­˜å‚¨åˆ°å…¨å±€ï¼Œä¾›åç»­ä½¿ç”¨
        window.__CUSTOM_CONFIG_LOADED__ = true;
    </script>
</head>

<body>
    <canvas id="canvas01"></canvas>

    <script type="module">
        import * as THREE from 'three';
        import { GLTFLoader } from 'three/addons/loaders/GLTFLoader.js';
        import { DRACOLoader } from 'three/addons/loaders/DRACOLoader.js';
        import ThreeJSAssetsManager from '../ThreeJSAssetManager/ThreeJSAssetsManager/ThreeJSAssetsManager.js';
        import sources from '../ThreeJSAssetManager/ThreeJSAssetsManager/World/sources.js';

        // æ¸…ç©º sources æ•°ç»„ï¼Œä¸åŠ è½½ä»»ä½•é»˜è®¤æ¨¡å‹
        sources.length = 0;

        // åˆå§‹åŒ–
        const canvas = document.getElementById('canvas01');
        const manager = new ThreeJSAssetsManager(canvas);

        // å…¨å±€è®¿é—®
        window.manager = manager;
        window.THREE = THREE;

        console.log('ğŸ¨ Three.js Editor initialized');
        console.log('ğŸ“¦ Available managers:', {
            postProcessor: !!manager.postProcessor,
            helperManager: !!manager.helperManager,
            interactionManager: !!manager.interactionManager,
            particleManager: !!manager.particleManager,
            performanceManager: !!manager.performanceManager,
            shaderManager: !!manager.shaderManager,
            physicsManager: !!manager.physicsManager,
            audioManager: !!manager.audioManager,
            webXRManager: !!manager.webXRManager
        });

        // è‡ªå®šä¹‰æ‹–æ‹½åŠ è½½ GLB/GLTF åŠŸèƒ½
        const dracoLoader = new DRACOLoader();
        dracoLoader.setDecoderPath('https://gcore.jsdelivr.net/npm/three@0.179.1/examples/jsm/libs/draco/');
        const gltfLoader = new GLTFLoader();
        gltfLoader.setDRACOLoader(dracoLoader);

        window.addEventListener('dragover', (e) => {
            e.preventDefault();
        }, false);

        window.addEventListener('drop', (e) => {
            e.preventDefault();

            const files = e.dataTransfer.files;
            if (files.length > 0) {
                const file = files[0];
                const filename = file.name.toLowerCase();

                if (filename.endsWith('.glb') || filename.endsWith('.gltf')) {
                    const url = URL.createObjectURL(file);
                    console.log(`ğŸ“‚ Loading dropped file: ${file.name}`);

                    gltfLoader.load(url, (gltf) => {
                        const model = gltf.scene;
                        model.name = file.name;
                        manager.scene.add(model);

                        // è‡ªåŠ¨è°ƒæ•´ç›¸æœºä»¥æŸ¥çœ‹æ¨¡å‹
                        const box = new THREE.Box3().setFromObject(model);
                        const size = box.getSize(new THREE.Vector3());
                        const center = box.getCenter(new THREE.Vector3());

                        // å°†æ¨¡å‹å±…ä¸­
                        model.position.x -= center.x;
                        model.position.y -= center.y;
                        model.position.z -= center.z;

                        console.log('âœ… Model loaded:', file.name);
                        console.log('ğŸ“Š Model info:', {
                            name: model.name,
                            children: model.children.length,
                            size: size
                        });

                        URL.revokeObjectURL(url);
                    }, (xhr) => {
                        console.log(`â³ Loading: ${(xhr.loaded / xhr.total * 100).toFixed(2)}%`);
                    }, (error) => {
                        console.error('âŒ Error loading model:', error);
                    });
                } else {
                    console.warn('âš ï¸ Only .glb or .gltf files are supported.');
                }
            }
        }, false);

        console.log('ğŸ’¡ Tip: Drag and drop GLB/GLTF files to load models');
    </script>
</body>

</html>