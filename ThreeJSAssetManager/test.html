<!DOCTYPE html>
<html lang="zh-CN">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ThreeJSAssetsManagerÊ°ÜÊû∂ÊµãËØïÈ°µ</title>

    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Arial', sans-serif;
            background: #000;
            overflow: hidden;
        }

        #canvas01 {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            outline: none;
        }

        .info {
            position: fixed;
            top: 20px;
            right: 20px;
            background: rgba(0, 0, 0, 0.8);
            color: #00ff88;
            padding: 15px 20px;
            border-radius: 8px;
            font-size: 14px;
            z-index: 1000;
            border: 1px solid #00ff88;
        }

        .info h3 {
            margin-bottom: 10px;
            font-size: 16px;
        }

        .info p {
            margin: 5px 0;
            font-size: 12px;
            color: #fff;
        }

        .info code {
            background: rgba(0, 255, 136, 0.2);
            padding: 2px 6px;
            border-radius: 3px;
            color: #00ff88;
        }
    </style>

    <!-- Import Maps ÈÖçÁΩÆ -->
    <script type="importmap">
    {
        "imports": {
            "three": "https://gcore.jsdelivr.net/npm/three@0.179.1/build/three.module.js",
            "three/addons/": "https://gcore.jsdelivr.net/npm/three@0.179.1/examples/jsm/",
            "lil-gui": "https://gcore.jsdelivr.net/npm/lil-gui@0.18.1/dist/lil-gui.esm.min.js",
            "cannon-es": "https://cdn.jsdelivr.net/npm/cannon-es@0.20.0/dist/cannon-es.js"
        }
    }
    </script>
</head>

<body>
    <canvas id="canvas01"></canvas>

    <script type="module">
        import * as THREE from 'three';
        import { GLTFLoader } from 'three/addons/loaders/GLTFLoader.js';
        import { DRACOLoader } from 'three/addons/loaders/DRACOLoader.js';
        import ThreeJSAssetsManager from './ThreeJSAssetsManager/ThreeJSAssetsManager.js';
        import config from './ThreeJSAssetsManager/config.js';

        // Ê£ÄÊµã URL ‰∏≠ÁöÑ #debug Ê†áÂøóÔºåÂº∫Âà∂ÂêØÁî® DebugUI
        if (window.location.hash === '#debug') {
            config.DebugUI.enabled = true;
            console.log('‚úÖ DebugUI enabled via URL hash');
        }

        // Á¶ÅÁî® DebugUI ÂÜÖÁΩÆÁöÑÊãñÊîæÂäüËÉΩÔºå‰ª•‰ΩøÁî® test.html ‰∏≠ÁöÑËá™ÂÆö‰πâÂÆûÁé∞
        if (config.DebugUI && config.DebugUI.DragDropGLB) {
            config.DebugUI.DragDropGLB.enabled = false;
        }

        // ÂêØÁî®‰∏Ä‰∫õÂäüËÉΩÁî®‰∫éÊµãËØï
        config.Helpers.grid.enabled = true;
        config.Helpers.axes.enabled = true;
        config.PostProcessing.enabled = false; // ÂèØÈÄöËøá DebugUI ÂêØÁî®
        config.Interaction.enabled = true;

        // ÂàùÂßãÂåñ
        const canvas = document.getElementById('canvas01');
        const manager = new ThreeJSAssetsManager(canvas);

        // ÂÖ®Â±ÄËÆøÈóÆ
        window.manager = manager;
        window.THREE = THREE;

        console.log('üöÄ ThreeJSAssetsManager initialized');
        console.log('üì¶ Available managers:', {
            postProcessor: !!manager.postProcessor,
            helperManager: !!manager.helperManager,
            interactionManager: !!manager.interactionManager,
            particleManager: !!manager.particleManager,
            performanceManager: !!manager.performanceManager,
            shaderManager: !!manager.shaderManager,
            physicsManager: !!manager.physicsManager,
            audioManager: !!manager.audioManager,
            webXRManager: !!manager.webXRManager
        });

        // Ê∑ªÂä†‰∏Ä‰∫õÊµãËØïÂØπË±°
        setTimeout(() => {
            // Ê∑ªÂä†Âú∞Èù¢
            const groundGeometry = new THREE.PlaneGeometry(10, 10);
            const groundMaterial = new THREE.MeshStandardMaterial({
                color: 0x333333,
                metalness: 0.1,
                roughness: 0.9
            });
            const ground = new THREE.Mesh(groundGeometry, groundMaterial);
            ground.rotation.x = -Math.PI / 2;
            ground.receiveShadow = true;
            ground.name = 'Ground';
            manager.scene.add(ground);

            console.log('‚úÖ Test objects added to scene');
        }, 100);

        // ‰∫§‰∫íÂõûË∞É
        if (manager.interactionManager) {
            manager.interactionManager.onClickEvent((object, intersection) => {
                console.log('üñ±Ô∏è Clicked:', object.name || object.type);
                if (object.material && object.material.color) {
                    object.material.color.setHex(Math.random() * 0xffffff);
                }
            });

            manager.interactionManager.onHover((object, intersection) => {
                console.log('üëÜ Hovering:', object.name || object.type);
            });
        }

        // ÊãñÊãΩÂä†ËΩΩ GLB/GLTF
        const dracoLoader = new DRACOLoader();
        dracoLoader.setDecoderPath('https://gcore.jsdelivr.net/npm/three@0.179.1/examples/jsm/libs/draco/');
        const gltfLoader = new GLTFLoader();
        gltfLoader.setDRACOLoader(dracoLoader);

        window.addEventListener('dragover', (e) => {
            e.preventDefault();
        }, false);

        window.addEventListener('drop', (e) => {
            e.preventDefault();

            const files = e.dataTransfer.files;
            if (files.length > 0) {
                const file = files[0];
                const filename = file.name.toLowerCase();

                if (filename.endsWith('.glb') || filename.endsWith('.gltf')) {
                    const url = URL.createObjectURL(file);
                    console.log(`üìÇ Loading dropped file: ${file.name}`);

                    gltfLoader.load(url, (gltf) => {
                        const model = gltf.scene;
                        model.name = file.name;
                        manager.scene.add(model);

                        // Ëá™Âä®Ë∞ÉÊï¥Ê®°Âûã‰ΩçÁΩÆÂà∞Âú∞Èù¢‰∏äÊñπ
                        const box = new THREE.Box3().setFromObject(model);
                        const size = box.getSize(new THREE.Vector3());
                        const center = box.getCenter(new THREE.Vector3());

                        model.position.x += (model.position.x - center.x);
                        model.position.y += (model.position.y - center.y) + size.y / 2;
                        model.position.z += (model.position.z - center.z);

                        console.log('‚úÖ Model loaded:', file.name);
                        URL.revokeObjectURL(url);
                    }, (xhr) => {
                        console.log(`‚è≥ Loading: ${(xhr.loaded / xhr.total * 100).toFixed(2)}%`);
                    }, (error) => {
                        console.error('‚ùå Error loading model:', error);
                    });
                } else {
                    console.warn('‚ö†Ô∏è Only .glb or .gltf files are supported.');
                }
            }
        }, false);
    </script>
</body>

</html>