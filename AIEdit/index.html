<!DOCTYPE html>
<html lang="zh-CN">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Three.js Editor - ThreeJSAssetsManager</title>

    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Arial', sans-serif;
            background: #000;
            overflow: hidden;
        }

        #canvas01 {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            outline: none;
        }
    </style>

    <!-- GitHub Actionsæ³¨å…¥çš„ç¯å¢ƒå˜é‡é…ç½® âš ï¸ å®‰å…¨è­¦å‘Š -->
    <script src="token-config.js"></script>
    
    <!-- Import Maps é…ç½® -->
    <script type="importmap">
    {
        "imports": {
            "three": "https://gcore.jsdelivr.net/npm/three@0.179.1/build/three.module.js",
            "three/addons/": "https://gcore.jsdelivr.net/npm/three@0.179.1/examples/jsm/",
            "lil-gui": "https://gcore.jsdelivr.net/npm/lil-gui@0.18.1/dist/lil-gui.esm.min.js",
            "cannon-es": "https://cdn.jsdelivr.net/npm/cannon-es@0.20.0/dist/cannon-es.js"
        }
    }
    </script>


    <script type="module">
        // å…ˆå¯¼å…¥é»˜è®¤é…ç½®å’Œè‡ªå®šä¹‰é…ç½®
        import defaultConfig from '../ThreeJSAssetManager/ThreeJSAssetsManager/config.js';
        import editConfig from './config.js';
        
        // å•ç‹¬å¯¼å…¥AIé…ç½®ä»¥ç¡®ä¿èƒ½è·å–åˆ°token
        let aiConfig = null;
        try {
            aiConfig = (await import('./config.js')).default;
        } catch (e) {
            console.warn('âš ï¸ æ— æ³•åŠ è½½AIé…ç½®:', e);
        }

        // æ·±åº¦åˆå¹¶é…ç½®
        function deepMerge(target, source) {
            for (const key in source) {
                if (source[key] && typeof source[key] === 'object' && !Array.isArray(source[key])) {
                    target[key] = target[key] || {};
                    deepMerge(target[key], source[key]);
                } else {
                    target[key] = source[key];
                }
            }
            return target;
        }

        // ç”¨ Edit é…ç½®è¦†ç›–é»˜è®¤é…ç½®
        deepMerge(defaultConfig, editConfig);

        console.log('âœ… Edit config merged into default config');

        // å°†åˆå¹¶åçš„é…ç½®å­˜å‚¨åˆ°å…¨å±€ï¼Œä¾›åç»­ä½¿ç”¨
        window.__CUSTOM_CONFIG_LOADED__ = true;
    </script>
</head>

<body>
    <canvas id="canvas01"></canvas>

    <script type="module">
        import * as THREE from 'three';
        import { GLTFLoader } from 'three/addons/loaders/GLTFLoader.js';
        import { DRACOLoader } from 'three/addons/loaders/DRACOLoader.js';
        import ThreeJSAssetsManager from '../ThreeJSAssetManager/ThreeJSAssetsManager/ThreeJSAssetsManager.js';
        import sources from '../ThreeJSAssetManager/ThreeJSAssetsManager/World/sources.js';
        import Pic2GLBManager from './AI/Pic2GLBManager.js';
        import config from './config.js';

        // æ¸…ç©º sources æ•°ç»„ï¼Œä¸åŠ è½½ä»»ä½•é»˜è®¤æ¨¡å‹
        sources.length = 0;

        // åˆå§‹åŒ–
        const canvas = document.getElementById('canvas01');
        const manager = new ThreeJSAssetsManager(canvas);

        // å…¨å±€è®¿é—®
        window.manager = manager;
        window.THREE = THREE;

        console.log('ğŸ¨ Three.js Editor initialized');
        console.log('ğŸ“¦ Available managers:', {
            postProcessor: !!manager.postProcessor,
            helperManager: !!manager.helperManager,
            interactionManager: !!manager.interactionManager,
            particleManager: !!manager.particleManager,
            performanceManager: !!manager.performanceManager,
            shaderManager: !!manager.shaderManager,
            physicsManager: !!manager.physicsManager,
            audioManager: !!manager.audioManager,
            webXRManager: !!manager.webXRManager
        });

        // åˆå§‹åŒ–AIåŠŸèƒ½
        console.log('ğŸ” manager.gui:', manager.gui);
        
        if (manager.gui) {
            const aiFolder = manager.gui.addFolder('ğŸ¤– AI');
            
            // Pic2GLBåŠŸèƒ½
            const pic2glbConfig = config.DebugUI?.AI?.Pic2GLB;
            const pic2glb = new Pic2GLBManager(manager, pic2glbConfig);
            window.pic2glb = pic2glb;
            
            const pic2glbFolder = aiFolder.addFolder('ğŸ“· å›¾ç‰‡è½¬GLB');
            
            // Tokenè®¾ç½®ï¼ˆä¼˜å…ˆçº§ï¼šconfig.js > æ³¨å…¥ç¯å¢ƒ > æœ¬åœ°å­˜å‚¨ï¼‰
            // ç›´æ¥ä»AIEditçš„config.jsè·å–tokenï¼Œé¿å…é…ç½®åˆå¹¶é—®é¢˜
            const configToken = aiConfig?.DebugUI?.AI?.Pic2GLB?.apiToken || '';
            const envToken = window.GITEE_AI_TOKEN || '';
            const localToken = localStorage.getItem('GITEE_AI_TOKEN') || '';
            
            console.log('ğŸ” åŸå§‹Tokenæ£€æŸ¥:', {
                aiConfig,
                configToken,
                'aiConfig?': !!aiConfig,
                'DebugUI?': !!aiConfig?.DebugUI,
                'AI?': !!aiConfig?.DebugUI?.AI,
                'Pic2GLB?': !!aiConfig?.DebugUI?.AI?.Pic2GLB,
                'apiToken?': !!aiConfig?.DebugUI?.AI?.Pic2GLB?.apiToken,
                mergedConfig: config
            });
            
            // ç¡®å®šæœ€ç»ˆä½¿ç”¨çš„tokenå’Œæ¥æº
            let finalToken, tokenSource;
            if (configToken) {
                finalToken = configToken;
                tokenSource = 'config.js';
            } else if (envToken) {
                finalToken = envToken;
                tokenSource = 'ç¯å¢ƒå˜é‡';
            } else if (localToken) {
                finalToken = localToken;
                tokenSource = 'æœ¬åœ°å­˜å‚¨';
            } else {
                finalToken = '';
                tokenSource = 'æœªé…ç½®';
            }
            
            // è®¾ç½®å…¨å±€tokenå’Œpic2glbçš„token
            window.GITEE_AI_TOKEN = finalToken;
            pic2glb.apiToken = finalToken;
            
            console.log('ğŸ” Tokenè®¾ç½®å®Œæˆ:', {
                configToken,
                envToken, 
                localToken,
                finalToken,
                tokenSource,
                globalToken: window.GITEE_AI_TOKEN,
                managerToken: pic2glb.apiToken
            });
            
            const tokenObj = {
                token: tokenSource === 'æœªé…ç½®' ? '' : (tokenSource === 'config.js' ? '***å·²é…ç½®***' : finalToken),
                source: tokenSource,
                setToken: function() {
                    if (configToken) {
                        alert('Tokenå·²åœ¨config.jsä¸­é…ç½®ï¼Œæ— æ³•ä¿®æ”¹ã€‚\nå¦‚éœ€æ›´æ”¹ï¼Œè¯·ä¿®æ”¹config.jsæ–‡ä»¶');
                        return;
                    }
                    if (envToken) {
                        alert('Tokenå·²é€šè¿‡ç¯å¢ƒå˜é‡é…ç½®ï¼Œæ— æ³•åœ¨å®¢æˆ·ç«¯ä¿®æ”¹ã€‚\nå¦‚éœ€æ›´æ”¹ï¼Œè¯·åœ¨GitHub Actionsä¸­ä¿®æ”¹');
                        return;
                    }
                    
                    if (this.token.trim()) {
                        localStorage.setItem('GITEE_AI_TOKEN', this.token.trim());
                        window.GITEE_AI_TOKEN = this.token.trim();
                        pic2glb.apiToken = this.token.trim();
                        console.log('âœ… Tokenå·²ä¿å­˜åˆ°æœ¬åœ°å­˜å‚¨');
                        statusObj.status = 'âœ… Tokenå·²é…ç½®';
                    } else {
                        localStorage.removeItem('GITEE_AI_TOKEN');
                        window.GITEE_AI_TOKEN = '';
                        pic2glb.apiToken = '';
                        console.log('âš ï¸ Tokenå·²æ¸…é™¤');
                        statusObj.status = 'âŒ Tokenæœªé…ç½®';
                    }
                },
                clearToken: function() {
                    if (configToken) {
                        alert('Tokenå·²åœ¨config.jsä¸­é…ç½®ï¼Œæ— æ³•æ¸…é™¤ã€‚');
                        return;
                    }
                    if (envToken) {
                        alert('Tokenå·²é€šè¿‡ç¯å¢ƒå˜é‡é…ç½®ï¼Œæ— æ³•æ¸…é™¤ã€‚');
                        return;
                    }
                    this.token = '';
                    this.setToken();
                },
                editConfig: function() {
                    alert('è¦ä¿®æ”¹config.jsä¸­çš„tokenï¼Œè¯·ï¼š\n\n1. æ‰“å¼€ AIEdit/config.js æ–‡ä»¶\n2. æ‰¾åˆ° DebugUI.AI.Pic2GLB.apiToken\n3. ä¿®æ”¹ä¸ºä½ çš„tokenå€¼\n4. ä¿å­˜å¹¶é‡æ–°éƒ¨ç½²');
                }
            };
            
            pic2glbFolder.add(tokenObj, 'source').name('ğŸ“ Tokenæ¥æº').listen();
            
            // æ ¹æ®tokenæ¥æºæ˜¾ç¤ºä¸åŒçš„æ§åˆ¶é€‰é¡¹
            if (configToken) {
                pic2glbFolder.add(tokenObj, 'token').name('ğŸ”‘ TokençŠ¶æ€').listen();
                pic2glbFolder.add(tokenObj, 'editConfig').name('âš™ï¸ ä¿®æ”¹config.js');
                pic2glbFolder.add({ showInfo: () => {
                    alert('âœ… Tokenæ¥è‡ªconfig.jsé…ç½®\n\nè¿™æ˜¯æœ€ä¼˜å…ˆçš„é…ç½®æ–¹å¼ã€‚\n\nä¼˜ç‚¹ï¼š\nâ€¢ ç‰ˆæœ¬æ§åˆ¶\nâ€¢ ä¸ä¼šæ„å¤–æ³„éœ²\nâ€¢ éƒ¨ç½²æ—¶ç”Ÿæ•ˆ\n\næ³¨æ„ï¼šéœ€è¦é‡æ–°éƒ¨ç½²æ‰èƒ½ç”Ÿæ•ˆ');
                } }, 'showInfo').name('â„¹ï¸ é…ç½®ä¿¡æ¯');
            } else if (envToken) {
                pic2glbFolder.add(tokenObj, 'token').name('ğŸ”‘ TokençŠ¶æ€').listen();
                pic2glbFolder.add({ showWarning: () => {
                    alert('âš ï¸ å®‰å…¨è­¦å‘Šï¼š\n\nTokené€šè¿‡GitHub Actionsç¯å¢ƒå˜é‡é…ç½®ï¼Œ\nå¯èƒ½ä¼šæš´éœ²åœ¨å®¢æˆ·ç«¯ä»£ç ä¸­ã€‚\n\nå»ºè®®ï¼š\nâ€¢ ä½¿ç”¨ä»£ç†æœåŠ¡æé«˜å®‰å…¨æ€§\nâ€¢ æˆ–ä½¿ç”¨config.jsé…ç½®');
                } }, 'showWarning').name('âš ï¸ å®‰å…¨æç¤º');
            } else {
                pic2glbFolder.add(tokenObj, 'token').name('ğŸ”‘ GITEE_AI_TOKEN').onChange(() => {
                    tokenObj.setToken();
                });
                pic2glbFolder.add(tokenObj, 'clearToken').name('ğŸ—‘ï¸ æ¸…é™¤Token');
            }
            
            // ä½¿ç”¨æç¤º
            const helpObj = {
                showHelp: function() {
                    let helpText = 'Tokené…ç½®ä¼˜å…ˆçº§ï¼š\n\nğŸ¥‡ config.js > ğŸ¥ˆ ç¯å¢ƒå˜é‡ > ğŸ¥‰ æœ¬åœ°å­˜å‚¨\n\n';
                    
                    if (configToken) {
                        helpText += 'âœ… å½“å‰ï¼šconfig.jsé…ç½®\n\n';
                        helpText += 'ä¿®æ”¹æ–¹æ³•ï¼š\n1. ç¼–è¾‘ AIEdit/config.js\n2. æ‰¾åˆ° DebugUI.AI.Pic2GLB.apiToken\n3. æ›¿æ¢ä¸ºä½ çš„token\n4. é‡æ–°éƒ¨ç½²';
                    } else if (envToken) {
                        helpText += 'âœ… å½“å‰ï¼šç¯å¢ƒå˜é‡é…ç½®\n\n';
                        helpText += 'ä¿®æ”¹æ–¹æ³•ï¼š\n1. GitHubä»“åº“è®¾ç½®\n2. Variables and secrets\n3. æ·»åŠ  GITEE_AI_TOKEN\n\nâš ï¸ æ³¨æ„ï¼šä¼šæš´éœ²åœ¨å®¢æˆ·ç«¯';
                    } else {
                        helpText += 'âšª å½“å‰ï¼šæœªé…ç½®\n\n';
                        helpText += 'æ¨èæ–¹æ³•ï¼š\n1. æœ¬åœ°ï¼šåœ¨ä¸Šæ–¹è¾“å…¥æ¡†è®¾ç½®\n2. ç”Ÿäº§ï¼šä½¿ç”¨config.jsæˆ–ç¯å¢ƒå˜é‡\n\næœ¬åœ°å­˜å‚¨ä»…åœ¨å½“å‰æµè§ˆå™¨æœ‰æ•ˆ';
                    }
                    
                    alert(helpText);
                }
            };
            pic2glbFolder.add(helpObj, 'showHelp').name('â“ ä½¿ç”¨å¸®åŠ©');
            
            // çŠ¶æ€æ˜¾ç¤º
            const statusObj = { status: finalToken ? 'ç­‰å¾…æ“ä½œ...' : 'âŒ Tokenæœªé…ç½®' };
            pic2glbFolder.add(statusObj, 'status').name('çŠ¶æ€').listen();
            pic2glb.statusCallback = (msg) => { statusObj.status = msg; };
            
            // ç¡®ä¿çŠ¶æ€æ­£ç¡®æ˜¾ç¤º
            console.log('ğŸ” çŠ¶æ€å¯¹è±¡åˆå§‹åŒ–:', {
                finalToken: !!finalToken,
                initialStatus: statusObj.status
            });
            
            // ä¸Šä¼ æŒ‰é’®
            const uploadObj = {
                upload: () => {
                    const input = document.createElement('input');
                    input.type = 'file';
                    input.accept = 'image/*';
                    input.onchange = (e) => {
                        const file = e.target.files[0];
                        if (file) pic2glb.uploadAndGenerate(file);
                    };
                    input.click();
                }
            };
            pic2glbFolder.add(uploadObj, 'upload').name('ğŸ“¤ ä¸Šä¼ å›¾ç‰‡ç”ŸæˆGLB');
            
            // ä¸‹è½½æŒ‰é’®
            const downloadObj = { download: () => pic2glb.downloadGLB() };
            pic2glbFolder.add(downloadObj, 'download').name('ğŸ“¥ ä¸‹è½½GLB');
            
            // å‚æ•°è®¾ç½®
            const paramsFolder = pic2glbFolder.addFolder('âš™ï¸ ç”Ÿæˆå‚æ•°');
            paramsFolder.add(pic2glb.params, 'seed', 0, 9999, 1).name('éšæœºç§å­');
            paramsFolder.add(pic2glb.params, 'num_inference_steps', 1, 20, 1).name('æ¨ç†æ­¥æ•°');
            paramsFolder.add(pic2glb.params, 'octree_resolution', 64, 256, 32).name('å…«å‰æ ‘åˆ†è¾¨ç‡');
            paramsFolder.add(pic2glb.params, 'guidance_scale', 1, 10, 0.5).name('å¼•å¯¼å¼ºåº¦');
            paramsFolder.add(pic2glb.params, 'texture').name('ç”Ÿæˆçº¹ç†');
            
            pic2glbFolder.open();
            aiFolder.open();
                console.log('âœ… AI Pic2GLB åŠŸèƒ½å·²åŠ è½½');
            
            // è°ƒè¯•ä¿¡æ¯
            console.log('ğŸ” Tokené…ç½®è°ƒè¯•ä¿¡æ¯:', {
                configToken: config?.DebugUI?.AI?.Pic2GLB?.apiToken,
                envToken: window.GITEE_AI_TOKEN,
                localToken: localStorage.getItem('GITEE_AI_TOKEN'),
                finalToken: window.GITEE_AI_TOKEN,
                tokenSource: tokenSource,
                pic2glbApiToken: pic2glb.apiToken
            });
        } else {
            console.warn('âš ï¸ DebugUI.gui ä¸å­˜åœ¨ï¼Œæ— æ³•æ·»åŠ AIåŠŸèƒ½');
        }

        // è‡ªå®šä¹‰æ‹–æ‹½åŠ è½½ GLB/GLTF åŠŸèƒ½
        const dracoLoader = new DRACOLoader();
        dracoLoader.setDecoderPath('https://gcore.jsdelivr.net/npm/three@0.179.1/examples/jsm/libs/draco/');
        const gltfLoader = new GLTFLoader();
        gltfLoader.setDRACOLoader(dracoLoader);

        window.addEventListener('dragover', (e) => {
            e.preventDefault();
        }, false);

        window.addEventListener('drop', (e) => {
            e.preventDefault();

            const files = e.dataTransfer.files;
            if (files.length > 0) {
                const file = files[0];
                const filename = file.name.toLowerCase();

                if (filename.endsWith('.glb') || filename.endsWith('.gltf')) {
                    const url = URL.createObjectURL(file);
                    console.log(`ğŸ“‚ Loading dropped file: ${file.name}`);

                    gltfLoader.load(url, (gltf) => {
                        const model = gltf.scene;
                        model.name = file.name;
                        manager.scene.add(model);

                        // è‡ªåŠ¨è°ƒæ•´ç›¸æœºä»¥æŸ¥çœ‹æ¨¡å‹
                        const box = new THREE.Box3().setFromObject(model);
                        const size = box.getSize(new THREE.Vector3());
                        const center = box.getCenter(new THREE.Vector3());

                        // å°†æ¨¡å‹å±…ä¸­
                        model.position.x -= center.x;
                        model.position.y -= center.y;
                        model.position.z -= center.z;

                        console.log('âœ… Model loaded:', file.name);
                        console.log('ğŸ“Š Model info:', {
                            name: model.name,
                            children: model.children.length,
                            size: size
                        });

                        URL.revokeObjectURL(url);
                    }, (xhr) => {
                        console.log(`â³ Loading: ${(xhr.loaded / xhr.total * 100).toFixed(2)}%`);
                    }, (error) => {
                        console.error('âŒ Error loading model:', error);
                    });
                } else {
                    console.warn('âš ï¸ Only .glb or .gltf files are supported.');
                }
            }
        }, false);

        console.log('ğŸ’¡ Tip: Drag and drop GLB/GLTF files to load models');
    </script>
</body>

</html>